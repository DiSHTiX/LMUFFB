# v0.4.18 Implementation Summary: Yaw Acceleration Smoothing

**Date**: 2025-12-16  
**Version**: 0.4.18  
**Objective**: Fix noise feedback loop between Slide Rumble and Yaw Kick effects

## Problem Statement

Users reported violent wheel behavior when both Slide Rumble and Yaw Kick effects were enabled simultaneously. The wheel would shake increasingly harder and feel like it was "fighting" the user.

### Root Cause Analysis

The issue was a **positive feedback loop**:

1. **Slide Rumble** injects high-frequency vibrations (sawtooth wave) into the steering wheel
2. These vibrations cause the yaw acceleration telemetry (`mLocalRotAccel.y`) to spike with noise
3. **Yaw Kick** reads these spikes and amplifies them (derivatives are extremely noise-sensitive)
4. The amplified force causes the wheel to shake harder
5. **Feedback loop**: Harder shaking → More noise → Stronger Yaw Kick → Even harder shaking

The user naturally blamed Slide Rumble, but the root cause was that **Yaw Kick was amplifying the noise**.

## Solution: Low Pass Filter

Implemented an **Exponential Moving Average (Low Pass Filter)** with alpha=0.1 to smooth the yaw acceleration data before using it for FFB.

### Filter Characteristics
- **Alpha = 0.1**: 10% new data, 90% history
- **Cutoff frequency**: ~1.6 Hz
- **Effect**: Filters out high-frequency vibration noise while preserving low-frequency rotation kicks

### Formula
```cpp
m_yaw_accel_smoothed = m_yaw_accel_smoothed + 0.1 * (raw_yaw_accel - m_yaw_accel_smoothed)
```

## Implementation Details

### Files Modified

1. **FFBEngine.h**
   - Added state variable: `double m_yaw_accel_smoothed = 0.0;`
   - Added LPF calculation before yaw force computation
   - Added comprehensive comments explaining the fix

2. **VERSION**
   - Updated to `0.4.18`

3. **CHANGELOG.md**
   - Added detailed v0.4.18 entry documenting the problem, solution, and impact

4. **docs/dev_docs/FFB_formulas.md**
   - Updated Yaw Acceleration formula documentation
   - Added explanation of the LPF and its parameters

5. **tests/test_ffb_engine.cpp**
   - Fixed `test_sop_yaw_kick()` to account for smoothing
   - Added `test_yaw_accel_smoothing()` - verifies LPF behavior
   - Added `test_yaw_accel_convergence()` - verifies convergence
   - Added `test_regression_yaw_slide_feedback()` - **critical regression test**

### Code Changes

**Before (v0.4.16)**:
```cpp
double yaw_force = data->mLocalRotAccel.y * m_sop_yaw_gain * 5.0;
sop_total += yaw_force;
```

**After (v0.4.18)**:
```cpp
double raw_yaw_accel = data->mLocalRotAccel.y;

// Apply Low Pass Filter
double alpha_yaw = 0.1;
m_yaw_accel_smoothed = m_yaw_accel_smoothed + alpha_yaw * (raw_yaw_accel - m_yaw_accel_smoothed);

// Use SMOOTHED value
double yaw_force = m_yaw_accel_smoothed * m_sop_yaw_gain * 5.0;
sop_total += yaw_force;
```

## Test Coverage

### Test Results (All Passed ✅)

**Test: Yaw Acceleration Smoothing (v0.4.18)**
- ✅ First frame smoothed to 10% of raw input (0.25 ~= 0.25)
- ✅ Second frame accumulated correctly (0.475 ~= 0.475)
- ✅ High-frequency noise rejected (max force 0.125 < 0.5)

**Test: Yaw Acceleration Convergence (v0.4.18)**
- ✅ Converged to steady-state after 50 frames (0.248712 ~= 0.25)
- ✅ Smoothly decaying after step change (0.22384)

**Test: Regression - Yaw/Slide Feedback Loop (v0.4.18)** ⭐
- ✅ No feedback loop detected (max force 0.293125 < 1.0)
- ✅ Average force remains low (avg 0.127382 < 0.5)
- ✅ System settled after noise removed (final force -0.0410781)

### Test Coverage Analysis

1. **Unit Tests**: Verify LPF mathematics (first frame, accumulation, convergence)
2. **Integration Tests**: Verify LPF rejects high-frequency noise
3. **Regression Test**: Simulates the exact bug scenario and verifies stability

The regression test is **critical** - it enables both Slide Rumble and Yaw Kick with extreme noise input (±10 rad/s²) and verifies that:
- Max force stays below 1.0 (no saturation)
- Average force stays low (noise cancels out)
- System settles when noise is removed (no persistent oscillation)

## Impact

### User Experience
- ✅ Users can now safely use Slide Rumble and Yaw Kick simultaneously
- ✅ No more violent wheel behavior or "fighting" sensation
- ✅ Yaw Kick still provides the intended rotation cue (low-frequency signal preserved)

### Technical
- ✅ System remains stable under high-frequency noise
- ✅ No performance impact (simple arithmetic operation)
- ✅ No configuration changes needed (alpha=0.1 is hardcoded and optimal)

## Temporary Workaround (for users on v0.4.16)

Users experiencing the issue can temporarily reduce the "SoP Yaw (Kick)" slider to a very low value (e.g., 0.1 or 0.0) until they upgrade to v0.4.18.

## Lessons Learned

1. **Derivatives are noise-sensitive**: Always apply smoothing to derivative values (acceleration, jerk, etc.)
2. **Feedback loops are subtle**: The interaction between effects can create unexpected behavior
3. **Test for interactions**: Regression tests should simulate realistic multi-effect scenarios
4. **Windows compilation quirk**: Always use `(std::max)` and `(std::min)` with parentheses to avoid macro conflicts

## References

- Bug Report: `docs/bug_reports/Fix - Smooth the Yaw Acceleration.md`
- Windows std::max Issue: `docs/dev_docs/windows_stdmax_macro_issue.md`
- FFB Formulas: `docs/dev_docs/FFB_formulas.md`

## Verification

- ✅ Code compiles successfully
- ✅ All 105 tests pass (0 failures)
- ✅ Regression test specifically validates the fix
- ✅ Documentation updated
- ✅ Version number incremented
