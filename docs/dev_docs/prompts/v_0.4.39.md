(note: this prompt was in markdown format, and was sent properly formatted to the agent. Only this version is missing formatting. )

# Prompt

You will have to work on the files downloaded from this repo https://github.com/coasting-nc/LMUFFB and start working on the tasks described below. Therefore, if you haven't done it already, clone this repo https://github.com/coasting-nc/LMUFFB and start working on the tasks described below.

Please initialize this session by following the Standard Task Workflow defined in AGENTS.md.

Sync: Run git fetch && git reset --hard origin/main for the LMUFFB repository to ensure you see the latest files.
Load Memory: Read AGENTS_MEMORY.md from the root dir of the LMUFFB repository to review build workarounds and architectural insights.
Load Rules: Read AGENTS.md from the root dir of the LMUFFB repository to confirm instructions.
Once you have reviewed these documents, please proceed with the following task:

Task: Implement Advanced Physics Reconstruction for Encrypted Telemetry

Reference Documents:

docs/dev_docs/Improving FFB App Tyres.md (Primary Source)
src/lmu_sm_interface/InternalsPlugin.hpp (source of truth for LMU shared memory interface)
docs/dev_docs/coordinate_system_reference.md (Critical for verification)
docs/dev_docs/FFB_formulas.md (Current implementation)
FFBEngine.h (Target file)
Context: The application currently suffers from "flat" Force Feedback on Le Mans Ultimate DLC/Encrypted content because critical telemetry variables (mTireLoad and mSuspForce) are zeroed out by the game engine. The current fallback mechanism (static 300N load) removes all dynamic weight transfer feel. We need to implement the "Adaptive Kinematic Load" and "Combined Friction Circle" models described in the reference report to reconstruct these forces mathematically.

Implementation Requirements:

Verification Phase (CRITICAL):

Before implementing the Kinematic Load Model, verify the coordinate system assumptions in the report against docs/dev_docs/coordinate_system_reference.md. Specifically, confirm the direction of mLocalAccel.z (Longitudinal) to ensure braking weight transfer shifts load to the front, not the rear.
Verify that calculate_manual_slip_ratio handles low-speed singularities correctly before integrating it into the core grip calculation.
Tire Load Reconstruction:

Implement calculate_kinematic_load in FFBEngine.h.
This function must estimate load based on Static Weight + Aerodynamic Load ($v^2$) + Longitudinal/Lateral Weight Transfer (derived from smoothed Accelerometer data).
Update the fallback logic in calculate_force: If mSuspForce is missing (approx 0.0), switch to this new Kinematic Model instead of the static 300N fallback.
Grip Reconstruction (Combined Friction Circle):

Update calculate_grip to consider Longitudinal Slip ($\kappa$) alongside Lateral Slip ($\alpha$).
Implement the "Combined Slip Vector" logic described in the report.
Goal: The steering should go light during straight-line braking lockups, not just during cornering understeer.
Signal Conditioning (Chassis Inertia):

Implement Time-Corrected Low Pass Filters for the acceleration inputs used in the Kinematic Load calculation.
This simulates the physical time it takes for a chassis to roll/pitch, preventing the weight transfer from feeling "digital" or instant.
Texture Refinement:

Update the Slide Texture logic to scale amplitude based on the new Kinematic Load and the inverse of the Grip Fraction (as per "Work-Based Scrubbing" in the report).
Deliverables:

Updated FFBEngine.h with the new physics models.
Updated tests/test_ffb_engine.cpp with new test cases verifying that:
Braking generates increased front load (Kinematic Model).
Acceleration generates increased rear load.
Combined slip (braking + turning) triggers grip reduction.
Updated docs/dev_docs/FFB_formulas.md reflecting the new math.
Git / Large Diff Issue
Issue: git status, git fetch, or other commands may fail with "The diff size is unusually large" if the repository state is significantly different or if build artifacts are not ignored.
Workaround: Rely on read_file, overwrite_file, and replace_with_git_merge_diff directly. Do not depend on bash commands for verification if this error occurs. Ensure .gitignore covers all build directories (e.g., tests/build/).
Git & Repo Management
Submodule Trap
Issue: Cloning a repo inside an already initialized repo (even if empty) can lead to nested submodules or detached git states.
Fix: Ensure the root directory is correctly initialized or cloned into. If working in a provided sandbox with .git, configure the remote and fetch rather than cloning into a subdirectory.
File Operations
Lesson: When moving files from a nested repo to root, ensure hidden files (like .git) are handled correctly or that the root .git is properly synced.
Tooling: replace_with_git_merge_diff requires exact context matching. If files are modified or desynchronized, overwrite_file_with_block is safer.